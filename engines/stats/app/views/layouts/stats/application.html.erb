<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="turbo-refresh-method" content="morph">
  <title><%= Stats.dashboard_title %></title>
  <%= csrf_meta_tags %>
  <%= action_cable_meta_tag %>

  <!-- Mona Sans Font from Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mona+Sans:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

  <style>
    :root {
      --bg-primary: #0c0c0c;
      --bg-card: #141414;
      --bg-elevated: #1a1a1a;
      --border: #262626;
      --border-subtle: #1f1f1f;
      --text-primary: #fafafa;
      --text-secondary: #a3a3a3;
      --text-muted: #525252;
      --accent: #a855f7;
    }

    *, *::before, *::after {
      font-family: 'Mona Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif !important;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Mona Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    }

    code, pre, .font-mono {
      font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace !important;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
    }

    /* Smooth transition for value updates */
    .stat-value, [id^="stat-"] {
      transition: background-color 0.4s ease-out;
    }

    [data-updating="true"] {
      background: rgba(34, 197, 94, 0.12) !important;
      border-radius: 4px;
    }

    /* Smooth table row transitions */
    .table-row {
      transition: background-color 0.2s ease;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: -0.025em;
      line-height: 1.1;
    }

    .stat-label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .table-row:hover {
      background: var(--bg-elevated);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.625rem;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .pill-purple { background: rgba(168, 85, 247, 0.12); color: #c084fc; }
    .pill-green { background: rgba(34, 197, 94, 0.12); color: #4ade80; }
    .pill-neutral { background: rgba(163, 163, 163, 0.12); color: #a3a3a3; }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.875rem;
      transition: opacity 0.15s;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }

    .btn-secondary:hover:not(:disabled) {
      opacity: 0.8;
    }

    .select-modern {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.375rem 0.75rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .select-modern:focus {
      outline: none;
      border-color: var(--accent);
    }

    .container-padding {
      width: 100%;
      max-width: 80rem;
      margin-left: auto;
      margin-right: auto;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    @media (min-width: 640px) {
      .container-padding {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
    }

    @media (min-width: 1024px) {
      .container-padding {
        padding-left: 2rem;
        padding-right: 2rem;
      }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body class="min-h-screen antialiased">
  <nav class="border-b border-[#1f1f1f] py-5">
    <div class="container-padding flex justify-between items-center">
      <div class="flex items-center gap-4">
        <div class="w-9 h-9 rounded-xl bg-[#a855f7] flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
        </div>
        <span class="text-lg font-semibold tracking-tight"><%= Stats.dashboard_title %></span>
      </div>
      <div class="flex items-center gap-8">
        <div id="connection-status" class="flex items-center gap-2.5">
          <span id="status-dot" class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
          <span id="status-text" class="text-sm text-[#737373]">Connecting</span>
        </div>
        <% if Stats.authentication_enabled? && current_api_key %>
          <%= link_to logout_path, data: { turbo_method: :delete }, class: "text-sm text-[#737373] hover:text-white transition-colors" do %>
            Sign out
          <% end %>
        <% end %>
      </div>
    </div>
  </nav>

  <main class="container-padding py-10">
    <% if flash[:alert] %>
      <div class="card mb-8 px-5 py-4 border-l-4 border-l-red-500">
        <span class="text-red-400 text-sm"><%= flash[:alert] %></span>
      </div>
    <% end %>
    <% if flash[:notice] %>
      <div class="card mb-8 px-5 py-4 border-l-4 border-l-green-500">
        <span class="text-green-400 text-sm"><%= flash[:notice] %></span>
      </div>
    <% end %>

    <%= yield %>
  </main>

  <script>
    (function() {
      'use strict';

      // ===================
      // Formatting Utilities
      // ===================

      const Format = {
        number(num) {
          if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
          if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
          return new Intl.NumberFormat().format(num);
        },

        duration(seconds) {
          const d = Math.floor(seconds / 86400);
          const h = Math.floor((seconds % 86400) / 3600);
          const m = Math.floor((seconds % 3600) / 60);
          if (d > 0) return `${d}d ${h}h`;
          if (h > 0) return `${h}h ${m}m`;
          return `${m}m`;
        },

        timeAgo(isoString) {
          if (!isoString) return '—';
          const date = new Date(isoString);
          if (isNaN(date.getTime())) return '—';
          const secs = Math.floor((Date.now() - date) / 1000);
          if (secs < 60) return 'now';
          const mins = Math.floor(secs / 60);
          if (mins < 60) return `${mins}m`;
          const hours = Math.floor(mins / 60);
          if (hours < 24) return `${hours}h`;
          return `${Math.floor(hours / 24)}d`;
        },

        escapeHtml(str) {
          if (str == null) return '';
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }
      };

      // ===================
      // Status Indicator
      // ===================

      const Status = {
        dot: document.getElementById('status-dot'),
        text: document.getElementById('status-text'),

        setLive() {
          if (this.dot) this.dot.className = 'w-2 h-2 rounded-full bg-emerald-500';
          if (this.text) {
            this.text.textContent = 'Live';
            this.text.className = 'text-sm text-emerald-500 font-medium';
          }
        },

        setConnecting() {
          if (this.dot) this.dot.className = 'w-2 h-2 rounded-full bg-amber-500 animate-pulse';
          if (this.text) {
            this.text.textContent = 'Connecting';
            this.text.className = 'text-sm text-amber-500';
          }
        }
      };

      // ===================
      // DOM Updates
      // ===================

      const prevValues = new Map();

      function updateElement(id, value) {
        const el = document.getElementById(id);
        if (!el) return;

        const str = String(value);
        const prev = prevValues.get(id);
        if (prev === str) return;

        prevValues.set(id, str);
        el.textContent = str;

        if (prev !== undefined) {
          el.setAttribute('data-updating', 'true');
          setTimeout(() => el.removeAttribute('data-updating'), 400);
        }
      }

      // ===================
      // Connections Table
      // ===================

      const ConnectionsTable = {
        data: [],
        page: 1,
        perPage: 10,
        prevFingerprint: '',

        update(connections) {
          const fp = connections.map(c =>
            `${c.id}:${c.subscription_count}:${c.authenticated_pubkeys?.length || 0}`
          ).join('|');

          if (fp === this.prevFingerprint) {
            this.updateTimes();
            return;
          }

          this.prevFingerprint = fp;
          this.data = connections;
          this.render();
        },

        updateTimes() {
          document.querySelectorAll('#connections-tbody tr[data-connection-id]').forEach(row => {
            const conn = this.data.find(c => c.id === row.dataset.connectionId);
            if (!conn) return;
            const cell = row.querySelector('.time-ago');
            if (cell) cell.textContent = Format.timeAgo(conn.connected_at);
          });
        },

        render() {
          const tbody = document.getElementById('connections-tbody');
          if (!tbody) return;

          const total = this.data.length;
          const maxPage = Math.max(1, Math.ceil(total / this.perPage));
          this.page = Math.min(this.page, maxPage);

          const start = (this.page - 1) * this.perPage;
          const pageData = this.data.slice(start, start + this.perPage);

          const totalEl = document.getElementById('connections-total');
          if (totalEl) totalEl.textContent = total;

          if (total === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-16 text-center text-[#525252]">No active connections</td></tr>';
          } else {
            tbody.innerHTML = pageData.map(c => `
              <tr class="table-row border-t border-[#1f1f1f]" data-connection-id="${Format.escapeHtml(c.id)}">
                <td class="py-4 font-mono text-sm text-[#a3a3a3]">${Format.escapeHtml(c.id?.substring(0, 12) || '')}</td>
                <td class="py-4 text-[#a3a3a3]">${Format.escapeHtml(c.ip_address) || '—'}</td>
                <td class="py-4"><span class="pill ${c.authenticated_pubkeys?.length ? 'pill-green' : 'pill-neutral'}">${c.authenticated_pubkeys?.length ? c.authenticated_pubkeys.length + ' pubkey' + (c.authenticated_pubkeys.length > 1 ? 's' : '') : 'Anonymous'}</span></td>
                <td class="py-4"><span class="pill pill-purple">${c.subscription_count || 0}</span></td>
                <td class="py-4 text-[#525252] text-sm time-ago">${Format.timeAgo(c.connected_at)}</td>
              </tr>
            `).join('');
          }

          this.updatePagination(total);
        },

        updatePagination(total) {
          const el = id => document.getElementById(id);
          const pagination = el('connections-pagination');
          if (!pagination) return;

          const start = (this.page - 1) * this.perPage + 1;
          const end = Math.min(start + this.perPage - 1, total);

          pagination.classList.toggle('hidden', total <= this.perPage);
          if (el('pagination-start')) el('pagination-start').textContent = total ? start : 0;
          if (el('pagination-end')) el('pagination-end').textContent = total ? end : 0;
          if (el('pagination-total')) el('pagination-total').textContent = total;
          if (el('pagination-prev')) el('pagination-prev').disabled = this.page <= 1;
          if (el('pagination-next')) el('pagination-next').disabled = this.page >= Math.ceil(total / this.perPage);
        },

        setupListeners() {
          document.getElementById('pagination-prev')?.addEventListener('click', () => {
            if (this.page > 1) { this.page--; this.render(); }
          });
          document.getElementById('pagination-next')?.addEventListener('click', () => {
            if (this.page < Math.ceil(this.data.length / this.perPage)) { this.page++; this.render(); }
          });
          document.getElementById('connections-per-page')?.addEventListener('change', e => {
            this.perPage = parseInt(e.target.value, 10);
            this.page = 1;
            this.render();
          });
        }
      };

      // ===================
      // Stats Poller
      // ===================

      const Poller = {
        interval: null,

        start() {
          if (this.interval) return;
          Status.setConnecting();
          this.fetch();
          this.interval = setInterval(() => this.fetch(), 5000);
        },

        async fetch() {
          try {
            const res = await fetch('<%= api_metrics_path %>');
            if (!res.ok) return;

            const data = await res.json();
            if (!data?.connections || !data?.events || !data?.system) return;

            Status.setLive();
            this.update(data);
          } catch (e) {
            console.error('Stats fetch error:', e);
          }
        },

        update(data) {
          // Stats cards
          updateElement('stat-connections', Format.number(data.connections.total));
          updateElement('stat-subscriptions', Format.number(data.connections.total_subscriptions));
          updateElement('stat-events-total', Format.number(data.events.total));
          updateElement('stat-events-today', Format.number(data.events.today));
          updateElement('stat-events-per-min', data.events.per_minute.toFixed(1));

          // System stats
          updateElement('stat-memory', data.system.memory.rss_mb);
          updateElement('stat-memory-panel', data.system.memory.rss_mb);
          updateElement('stat-memory-total', data.system.memory.total_mb);
          updateElement('stat-cpu', data.system.cpu.load_percent);
          updateElement('stat-load-avg', data.system.cpu.load_average);
          updateElement('stat-threads', data.system.process.thread_count);
          updateElement('stat-uptime', Format.duration(data.system.process.uptime_seconds));
          updateElement('stat-db-pool', `${data.system.database.connections_in_use}/${data.system.database.pool_size}`);

          // Progress bars
          window.updateProgressBars?.(
            data.system.cpu.load_percent,
            data.system.memory.rss_mb,
            data.system.memory.total_mb,
            data.system.database.connections_in_use,
            data.system.database.pool_size
          );

          // Connections table
          if (Array.isArray(data.connections.details)) {
            ConnectionsTable.update(data.connections.details);
          }

          // Timestamp
          if (data.collected_at) {
            updateElement('last-updated', new Date(data.collected_at).toLocaleTimeString());
          }
        }
      };

      // ===================
      // Initialize
      // ===================

      document.addEventListener('DOMContentLoaded', () => {
        ConnectionsTable.setupListeners();
        if (document.getElementById('stats-dashboard')) {
          Poller.start();
        }
      });
    })();
  </script>
</body>
</html>
